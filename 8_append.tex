%!TEX root = main-cav.tex

\begin{appendix}

\section{Formal Semantics of the Programming Language}
\begin{figure}
\begin{center}
	\hspace{-0.4cm}
	\scalebox{0.9}{
		\begin{tabular}{|l|l|}
			\hline
			Transitions&
			Side Condition\\
			\hline
			$(y := e;p, w, \rho) \longrightarrow (p, w, \rho')$&
			$\rho'=\rho[\eval{e}{\rho}/y]$\\
			
%			$\rho'(z) =\rho(z)$ for $z\neq y$, $\rho'(y) = \eval{\rho}{e}$\\
			
			$(y \addeq e;p, w, \rho) \longrightarrow (p, w, \rho')$&
			$\rho'=\rho[\eval{y+e}{\rho}/y]$\\
%			$\rho'(z) =\rho(z)$ for $z\neq y$, $\rho'(y) = \eval{y+e}{\rho}$\\
			
			$(\ite{g}{s_1}{s_2};p, w, \rho) \longrightarrow (s_1;p, w, \rho)$&
			$\rho \models g$\\
			
			$(\ite{g}{s_1}{s_2};p, w, \rho) \longrightarrow (s_2;p, w, \rho)$& $\rho \not \models g$\\
			
			$(\nnext;p, w, \rho) \longrightarrow (p, \tail(w), \rho')$&
			$\rho'=\rho[\head(w)/\cur]$ if $w \neq \varepsilon$ \\
			
			$(x:=\cur;p, w, \rho) \longrightarrow (p, w, \rho')$&
			$\rho'  =\rho[\rho(\cur)/x]$\\
			
			$(\loopL{s};\mbox{ret }r, w, \rho) \longrightarrow (s;\loopL{s};\mbox{ret }r, w, \rho)$& \\
			
		%	$(\loopL{s};s;\mbox{ret }r, w, \rho) \longrightarrow (s;\loopL{s};s;\mbox{ret }r, w, \rho)$& \\

			
			$(\loopL{s};\mbox{ret }r, \epsilon, \rho) \longrightarrow (\mbox{ret }r,  \epsilon, \rho)$& 	\\	

		%	$(\loopL{s};s;\mbox{ret }r, \epsilon, \rho) \longrightarrow (s;\mbox{ret }r,  \epsilon, \rho)$& 	\\
			\hline
			
		\end{tabular}
	}
	\caption{The Semantics of the Programming Language}
	\label{fig:semantics}
\end{center}
\end{figure}


Formally, the semantics of a program $p$ in the programming language is defined as a transition system in Fig.~\ref{fig:semantics}. Let $p$ be a reducer program and $w$ be an input data word.  Each configuration of the transition system is a triple $(p', w', \rho)$, where $p'$ is a program, $w'$ is a suffix of $w$, and $\rho$ is a valuation over $X^+\cup Y$ such that $\rho(\cur)=\head(w')$ (where if $w'=\varepsilon$, then $\head(w')=\bot$). 
Let $\rho_0$ denote a valuation which assigns each control and data variable an initial value, and $\rho_w$ be the valuation such that $\rho_w(\cur)=\head(w)$ and $\rho_w(z) = \rho_0(z)$ for each $z \in X \cup Y$.
The initial configuration is $(p, \tail(w), \rho_w)$.
We use $p_{\rho_0}(w)$ to denote the \emph{output} of $p$ on $w$ wrt. $\rho_0$. Then $p_{\rho_0}(w) =d$ if there exists a path from the initial configuration $(p, w, \rho_w)$ to some return configuration $(\mbox{ret }r,  \epsilon, \rho_r)$ such that $
\eval{r}{\rho_r}=d$. Otherwise, $p_{\rho_0}(w)=\bot$. Since the program is deterministic, i.e., given an initial valuation $\rho_0$, each input data word has at most one output, the semantics of $p$ is well-defined.

\section{Proofs in Section~\ref{sec:def-snt}}




\newcommand\assume{\mathsf{assume}}

\newcommand\loc{\mathfrak{l}}

\noindent {\bf Proposition~\ref{prop-mrprog-to-snt}}.
{\it 
For each reducer program $p$, one can construct an equivalent SNT $\Ss$ where the number of states and the maximum number of simple cycles in an SCC of the transition graph are at most exponential in the number of branching statements in $p$. 
}

\smallskip

\begin{proof}
We introduce a few notations first.

Let $s$ be a loop-free program. An \emph{execution path} $\pi$ of $s$ is a maximal path in the control flow graph of $s$ (here we use the standard definition of control flow graphs). Each execution path $\pi$ corresponds to a program $s_\pi$ obtained by sequentially composing the statements in $\pi$, where the statements $\assume(g)$ are used to represent the guards $g$. Then $s$ can be seen as a union of $s_\pi$, where $\pi$ ranges over the execution paths of $s$. 

Let $p$ be a reducer program of the form $s_1; \nnext; \loopL{s_2;\nnext;}$; ret $r$.  In the following, we show how to construct an SNT $\Ss_p$ to simulate $p$.

The loop body $s_2;\nnext$ can be seen as a union of programs $p_\pi$ for execution paths $\pi$. We assume that no two distinct programs $p_\pi$ share locations. We first transform the loop into a collection of state-disjoint (except the state $\loc_0$, the entry point of the loop)  cycles $C_\pi$, one for each program $p_\pi$.  Let us focus on a program $p_\pi$. The set of states in $C_\pi$ comprises the location $\loc_0$ which is the entry point of the loop, and the locations succeeding each $\nnext$ statement in $p_\pi$. Moreover, we identify the location succeeding the last $\nnext$ statement and the entry point. The effect of the subprogram $s'$ between two successive $\nnext$ statements in the locations $\loc_1,\loc_2$ can be summarized into a transition  $(\loc_1, g', \eta', \loc_2)$ of $p_\pi$. This is possible due to the following two constraints: 1) the conditions $g$ in the statements $\ite{g}{s'_1}{s'_2}$  of $p_\pi$ are the conjunctions of $\cur \odot c$ and $\cur \odot x$, 2) the assignments to the control variables are of the form $x:=\cur$, and the assignments to the data variables are of the form $y:=e$ and $y {+=} e$, where $e$ contains only control variables or $\cur$. As a result of the two constraints, we can trace the evolvement of the values of the control variables and simulate all the statements $\assume(g)$ occurring in $s'$ by a guard $g'$ (obtained from these guards $g$ by some variable substitutions),  moreover, the effects of all the assignments therein can be summarized into an assignment function $\eta'$.  Similarly, we can do the same for the subprogram between the entry point and the first $\nnext$ statement of $p_\pi$.

In addition, each execution path of $s_1;\nnext;$ can be simulated by a simple path of transitions of $\Ss_p$, which ends in the state $\loc_0$, the entry point of the loop.

The return statement t is handled by adding a transition with guards of the form $\cur=\wend$ from the state $\loc_0$  to a sink state $\loc'$.
The output function $O_p$ of $\Ss_p$ is defined as follow: $O_p(\loc') = r$ and $O(\loc)$ is undefined for all the other states $\loc$.


Because in the program ``$s_1; \nnext; \loopL{s_2;\nnext;}$; ret $r$'', the subprogram $s_2$ contains no occurrences of $\nnext;$, we know that each nontrivial SCC  in $\Ss_p$ comprises a collection of self-loops around a unique state. Therefore, $\Ss_p$ is generalized-flat.
\qed
\end{proof}

\hide{
\begin{algorithm}[H]
	%  \SetAlgoLine
	\KwData{A reducer program $p$}
	$Q=\{q_0\}, \delta=\emptyset, O=\emptyset$, $\mathsf{toState}(p) =q_0$, $\mathsf{toVisit}=\{(\mathsf{toState}(p),p,\ltrue,\emptyset)\}$\;
	\While{$\mathsf{toVisit}\neq \emptyset$}{
		remove $(q,p,g,\eta)$ from $\mathsf{toVisit}$\;
		\Switch{$p$}{
			\lCase{$y := e;p'$,$y \addeq e;p'$,$x'=x;p'$: }{add $(q,p',g,\eta[e/y])$, $(q,p',g,\eta[(y+e)/y])$, $(q,p',g,\eta[x'/x])$ to $\mathsf{toVisit}$, respectively}
			\lCase{$\ite{g'}{s_1}{s_2};p'$: }{add both $(q,s_1;p',g\wedge g',\eta)$ and $(q,s_2;p',g\wedge \neg g',\eta)$ to $\mathsf{toVisit}$}
			\lCase{$\loopL{s;}\mbox{ret }r$: }{add both $(q,s;\loopL{s;}\mbox{ret }r,g,\eta)$ and $(q,\mbox{ret }r, g,\eta)$ to $\mathsf{toVisit}$}
			\lCase{$\nnext;p'$: }{\label{alg:next}
				\uIf{$\mathsf{toState}(p') \not\in Q$}{add $(\mathsf{toState}(p'),p',\ltrue,\emptyset)$ to $\mathsf{toVisit}$ and add $\mathsf{toState}(p')$ to $Q$}
				add $(q, \mathsf{toState}(p'),g,\eta)$ to $\delta$
			}
			\lCase{$\mbox{ret }r: $}{\label{alg:output}
				add a fresh state $q_r$ to $Q$, 
				add $(q, q_r,g,\eta)$ to $\delta$, and $O:=O[r/q_r]$}
		}
	}
	\Return $(Q,X,Y,\delta, \mathsf{toState}(p),O)$\;
	
	\caption{Translate a Reducer Program to a SNT}
	\label{fig:reducer2SNT}
\end{algorithm}
We use a tuple $(q,p,g,\eta)$ to store intermediate results of the translation, where $q$ is the source SNT state, $p$ is a reducer program, $g$ is a guard, and $\eta$ is an assignment.
The algorithm begins with the tuple $(p,p,\ltrue,\emptyset)$. The algorithm add a transition to SNT only when a $\nnext$ statement is encountered (line~\ref{alg:next}). When a $\mbox{ret }r$ statement is encountered, the algorithm adds a fresh state $q_r$ to the SNT and extends the output function to $O[r/q_r]$ (line~\ref{alg:output}).

The SNT returned from Algorithm~\ref{fig:reducer2SNT} is not yet generalized flat. It might have cycles sharing more than one states. All the cycles coming from the loop and branches inside the loop. There must be at least one state $s$ shared by all cycles. Therefore, we can make it generalized flat by duplicating all shared stated other than $s$ so all cycles will have their own copy of the shared states other than $s$.  
}

\vspace{4mm}

\noindent {\bf Proposition~\ref{prop-snt-cmm-to-eqv}}. 
\emph{The commutativity problem of SNTs is reduced to the equivalence problem of SNTs in polynomial time}.

\begin{proof}
Suppose that $\Ss=(Q, X, Y, \delta, q_0, O)$ is an SNT such that $X=\{x_1,\dots,x_k\}$ and $Y=\{y_1,\dots,y_l\}$. Without loss of generality, we assume that the output of $\Ss$ is defined only for data words of length at least two. We will construct two SNTs $\Ss_1$ and $\Ss_2$ so that $\Ss$ is commutative iff $\Ss$ is equivalent to both $\Ss_1$ and $\Ss_2$.
\begin{itemize}
\item The intuition of $\Ss_1$ is that over a data word $w=d_1 d_2 d_3 \dots d_n\wend$ with $n\ge 2$, $\Ss_1$ simulates the run of $\Ss$ over $d_2 d_1 d_3 \dots d_n\wend$, that is, the data word obtained from $w$ by swapping the first two data values.
%
\item The intuition of $\Ss_2$ is that over a data word $w=d_1 d_2 d_3 \dots d_n\wend$ with $n\ge 2$, $\Ss_1$ simulates the run of $\Ss$ over $d_2 d_3 \dots d_n d_1\wend$, that is, the data word obtained from $w$ by moving the first data value to the end. 
\end{itemize}
The correctness of this reduction follows from Proposition 1 in \cite{CHSW15}.

\smallskip

\noindent {\it The construction of $\Ss_1$}.

Intuitively, over a data word $w=d_1d_2 d_3 \dots d_n\wend$, we introduce an additional write-once variable $x'$ to store $d_1$, then simulates the run of $\Ss$ over $d_2 d_1 d_3 \dots d_n\wend$ as follows: When reading $d_2$ in $w$, the variables are updated properly by letting $x'$ to represent $d_1$ and $\cur$ to represent $d_2$.



Let $q'_{0},q'_{1} \not \in Q$ and $x' \not \in X$. Then $\Ss_1 = (Q \cup \{q'_{0},q'_1\}, X \cup \{x'\}, Y, \delta_1, q'_{0}, O_1)$ such that 
\begin{itemize}
\item $O_1(q'_0)$ and $O_1(q'_1)$ are undefined, and for each $q \in Q$, $O_1(q)=O(q)$,
%
\item $\delta_1$ is constructed from $\delta$ as follows,
\begin{itemize}
\item each element of $\delta$ is an element of $\delta_1$,
%
\item for each pair of transitions $q_0 \xrightarrow{(g_1,\eta_1)} q_1 \xrightarrow{(g_2,\eta_2)} q_2$ in $\Ss$, we add the transitions $(q'_0, \ltrue, \eta'_1, q'_1)$ and $(q'_1, g', \eta'_2, q_2)$ into $\delta_1$. Intuitively, we use $x'$ to store the value of $d_1$ in $ \eta'_1$ and summarize the computation of $\eta_1$ and $\eta_2$ in $\eta'_2$ with the information that $d_1$ is stored in $x'$ and $d_2$ is stored in $\cur$.


Formally, $\eta'_1, g', \eta'_2$ are defined as follows.
\begin{itemize}
\item $\eta'_1(x')=\cur$ and $\eta'_1(z)$ is undefined for all $z \in X\cup Y$. This implies that after the transition $(q'_0, \ltrue, \eta'_1, q'_1)$, each variable $z \in X \cup Y$ still holds the initial value.  
%
\item $g' = g_1 \wedge g'_2$, where $g'_2$ is obtained from $g_2$ by replacing $\cur$ with $x'$, and each $x \in X\cap \dom(\eta_1)$ with $\eta_1(x)$.
%
\item For each $z \in X\cup Y$, if $z \in \dom(\eta_2)$, let $\eta_2^r(z)$ be the expression obtained by replacing all occurrences of $\cur$ in $\eta_2(z)$ with $x'$,
then $\eta'_2(z)$ is obtained by substituting all occurrences of variables $z' \in \dom(\eta_1)$ in $\eta_2^r(z)$ with $\eta_1(z')$. 
\item For each $z \in X\cup Y$, if $z \notin \dom(\eta_2)$, then $\eta'_2(z)=\eta_1(z)$.
%

\hide{
\item For each $y_j \in Y$, if $y_j \in \dom(\eta_2)$, then 
\[
\begin{array}{l c l}
\eta'_2(y_j) & = & (a_{j} + b_{j}\cur) + a'_{j} + b'_{j,0} x' + \sum \limits_{x_{j'} \in \dom(\eta_1)} b'_{j,j'} \cur \\
& = & (a_{j} + a'_{j}) + b'_{j,0} x' + (b_{j}  + \sum \limits_{x_{j'} \in \dom(\eta_1)} b'_{j,j'} )\cur,
\end{array}
\]
(or 
\[
\begin{array}{l c l}
\eta'_2(y_j) & = & a'_{j} + b'_{j,0} x' + \sum \limits_{x_{j'} \in \dom(\eta_1)} b'_{j,j'} \cur  \\
& = & a'_{j} + b_{j,0} x' + (\sum \limits_{x_{j'} \in \dom(\eta_1)} b'_{j,j'}  )\cur.
\end{array}
\], respectively).

%
Otherwise, if $y_j \in \dom(\eta_1)$, then $\eta'_2(y_j)= a_{j} + b_{j} \cur$. Otherwise, $\eta'_2(y_j)$ is undefined.}
\end{itemize}
\end{itemize}
\end{itemize}

\smallskip

\noindent {\it The construction of $\Ss_2$}.

Intuitively, over a data word $w=d_1\dots d_n\wend$, we introduce an additional control variable $x'$ to store $d_1$, then simulates the run of $\Ss$ over $d_2\dots d_n d_1$: When reading $\wend$ in $w$, the variables are updated properly by letting $x'$ to represent $d_1$.

%Since we only accept data words end at $\wend$, it is safe to assume that in the SNT $\Ss$, the target state of any transition with the guard $\cur = \wend$ is a sink state, i.e., a state without any outgoing transitions.


Suppose $q'_{0} \not \in Q$ and $x' \not \in X$. Then $\Ss_2 = (\{q'_0\} \cup Q, X\cup\{x'\}, Y, \delta_2, q'_{0}, O_2)$ such that  
\begin{itemize}
\item $O_2(q'_0)$ is undefined, and for each $q \in Q$, $O_2(q)=O(q)$,	
	
\item $\delta_2$ is constructed from $\delta$ as follows,
	\begin{itemize}
	\item each element of $\delta$ whose guard does not contain $\cur = \wend$ is an element of $\delta_2$,
	%

	\item we add the transition $q'_0 \xrightarrow{(\ltrue,\eta'_1)} q_0$ to $\delta_2$, where $\eta'_1(x') =\cur$ and $\eta'_1(z)$ is undefined for all $z \in X\cup Y$.

	\item for each pair of transitions $q_1 \xrightarrow{(g_1 \wedge \cur \neq \wend, \eta_1)} q_2 \xrightarrow{(g_2\wedge \cur=\wend, \eta_2)} q_3$ in $\Ss$, we add the transition $(q_1, g', \eta'_2, q_3)$ into $\delta_2$. Intuitively, we use $x'$ to store the value of $d_1$ in $ \eta'_1$ and summarize the computation of $\eta_1$ and $\eta_2$ in $\eta'_2$ with the information that $d_1$ is stored in $x'$.


	Formally, $g',\eta'_2$ are defined in the following. 
		\begin{itemize}
		\item $g' = g'_1 \wedge g'_2 \wedge(\cur=\wend)$, where $g'_1$ and $g'_2$ are obtained from $g_1,g_2$ as follows: $g'_1$ is obtained from $g_1$ by replacing all occurrences of $\cur$ with $x'$, and $g'_2$ is obtained from $g_2$ by replacing each $x \in X\cap \dom(\eta_1)$ with $\eta_1(x)$, then substituting all occurrences of $\cur$ with $x'$.
		%
		\item For each $z \in X\cup Y$, if $z \in \dom(\eta_2)$, then $\eta'_2(z)$ is the expression obtained from $\eta_2(z)$ by replacing all occurrences of variables $z' \in \dom(\eta_1)$ therein with $\eta_1(z')$ and then substituting all occurrences of $\cur$ with $x'$. 
		\item For each $z \in X\cup Y$, if $z \in \dom(\eta_1) \setminus \dom(\eta_2)$, then $\eta'_2(z)$ is the expression obtained from $\eta_1(z)$ by substituting all occurrences of $\cur$ with $x'$.
		\item For each $z \in X\cup Y$, if $z \notin \dom(\eta_2) \cup \dom(\eta_1)$, then $\eta'_2(z)$ is undefined.
		%

		\end{itemize}
	\end{itemize}
\end{itemize}

It is easy to see that the size of both $\Ss_1$ and $\Ss_2$ are polynomial with respect to the size of $\Ss$.
Note that $\Ss_1$ and $\Ss_2$ constructed above preserve the generalized-flatness and mononicity of $\Ss$, since the constructions do not modify the transitions in the nontrivial SCCs of the transition graph.
\qed
\end{proof}


\noindent {\bf Proposition \ref{prop-snt-eqv-to-nzero}}.
\emph{From two SNTs $\Ss_1$ and $\Ss_2$, an SNT $\Ss_3$ can be constructed in polynomial time such that  $(\Ss_1)_{\rho_0}(w\wend) \neq (\Ss_2)_{\rho_0}(w\wend)$ for some  data word $w \wend$ and valuation $\rho_0$  iff $(\Ss_3)_{\rho_0}(w\wend) \not\in \{\bot,0\}$ for some data word $w\wend$ and valuation $\rho_0$.}

\begin{proof}
Let $\Ss_1 = (Q_1,X_1,Y_1,\delta_1,q_{1,0}, O_1)$ and  $\Ss_2 = (Q_2,X_2,Y_2,\delta_2,q_{2,0}, O_2)$ be two monotone SNTs. Without loss of generality, we assume that $Q_1 \cap Q_2 = \emptyset$, $X_1 \cap X_2 = \emptyset$, and $Y_1 \cap Y_2 = \emptyset$. 

We first construct $\Ss$ as the product of $\Ss_1$ and $\Ss_2$. Specifically, $\Ss=(Q_1 \times Q_2, X_1 \cup X_2, Y_1 \cup Y_2, \delta, (q_{1,0},q_{2,0}), O)$, where
\begin{itemize}
\item $\delta$ comprises $((q_1,q_2), g_1 \wedge g_2, \eta_1 \cup \eta_2, (q'_1,q'_2))$ such that $(q_1,g_1,\eta_1,q'_1) \in \delta_1$, $(q_2,g_2,\eta_2,q'_2) \in \delta_2$, and $g_1 \wedge g_2$ is satisfiable,
%
\item for each $(q_1,q_2) \in Q_1 \times Q_2$, 
\begin{itemize}
\item if $O_1(q_1)$ is defined and $O_2(q_2)$ is undefined or vice versa, then $O((q_1,q_2))=1$, 
%
\item otherwise, if both $O_1(q_1)$ and $O_2(q_2)$ are defined, then $O((q_1,q_2))=O_1(q_1) - O_2(q_2)$, 
%
\item otherwise (both $O_1(q_1)$ and $O_2(q_2)$ are undefined), $O((q_1,q_2))$ is undefined. 
\end{itemize}
\end{itemize}
From the aforementioned construction, it is easy to see that $\Ss_1$ and $\Ss_2$ are  inequivalent iff there is a data word $w$ such that the output of $\Ss$ over $w$ is non-zero. Moreover, since both $\Ss_1$ and $\Ss_2$ are generalized-flat and monotone, we know that $\Ss$ is generalized-flat and monotone as well.   \qed
\end{proof}


\noindent {\bf Proposition~\ref{prop-snt-norm}}.
{
For each SNT $\Ss$, the nonzero-output problem of $\Ss$ can be reduced to a series of the nonzero-output problems of normalized SNTs $\Ss'$ in exponential time.
}
\smallskip

\newcommand{\tpo}{\mathsf{TPO}}

%\newcommand{\fn}{\mathsf{FN}}

\begin{proof}
Suppose $\Ss = (Q, X, Y, \delta, q_0, O)$ is an SNT such that $X=\{x_1,\dots, x_k\}$. Our goal is to reduce the nonzero-output problem of $\Ss$ to a series of  nonzero-output problems of normalized SNTs $\Ss'  = (Q', X, Y, \delta', q'_0, O')$.

%Without loss of generality, we assume that the set of write-once control variables of $\Ss$ satisfies that $X_{\sf w} = \{x_1,\dots, x_{k'} \}$ for some $k' \ge 0$ (If $k'=0$, then $X_{\sf w} = \emptyset$).

%We divide the reduction into two steps. At first, we construct a collection of SNTs $\Ss'' = (Q'', X, Y, \delta'', q''_0, O'')$ that are path-feasible and state-dominating, but not necessarily storage-irredundant. Then, we transform each SNT $\Ss''$ into a normalized $\Ss'$.

Let $\tpo_{X}$ denote the set of total preorders between control variables (Recall that a total preorder over $X$ is reflexive and transitive relation $\preceq$  over $X$ such that for each $x_i, x_j \in X$, either $(x_i, x_j) \in \preceq$ or $(x_j, x_i) \in \preceq$). For $\preceq \in \tpo_X$ and $x_i, x_j \in X$,  $x_i$ is said to be a \emph{$\preceq$-successor} of  $x_j$ or $x_j$ is said to be a \emph{$\preceq$-predecessor} of $x_i$, if $(x_j, x_i) \in \preceq$, $(x_i, x_j) \not \in \preceq$, and for each $x_{i'} \in X$ such that $(x_j, x_{i'}) \in \preceq$, it holds that $(x_i, x_{i'}) \in \preceq$. 
%In addition, let $\fn_X$ denote the set of functions over $X$.

Then for each $\preceq_0 \in \tpo_X$, we construct an SNT $\Ss'= (Q', X, Y, \delta', q'_0, O')$ as follows: $Q'= Q \times \tpo_X$, and $q'_0=(q_0,  \preceq_0)$. Moreover, $O'$ is defined as follows: For each $(q, \preceq) \in Q'$, $O'((q, \preceq)) = O(q)$. It remains to define $\delta'$.

The transition set $\delta'$ is defined by the following rules:
\begin{itemize}
\item For each $(q, g \wedge \cur \neq \triangleright, \eta, q') \in \delta$, $\delta'$ includes all the transitions $(q, \preceq) \xrightarrow{(g' \wedge \cur \neq \triangleright, \eta)} (q', \preceq')$ satisfying the following constraints. 
\begin{itemize}
\item  $g'$ is of the form $\cur = x_i$ where $x_i \in X$, or of the form $\cur > x_j \wedge \cur < x_i$ such that $x_i \in X$ is a $\preceq$-successor of $x_j \in X$, or of the form $\cur > x_i$ such that there does not exist a $\preceq$-successor of $x_i$, or of the form $\cur < x_i$ such that there does not exist a $\preceq$-predecessor of $x_i$.
%
\item $\preceq$, $g$ and $g'$ are compatible, more precisely, $\varphi_{\preceq} \wedge g \wedge g'$ is satisfiable, where $\varphi_{\preceq} \equiv \bigwedge \limits_{ i< j} \psi_{x_i, x_j}$, and for each pair of indices $i, j \in [k]$ such that $i < j$,  if $(x_i, x_j), (x_j, x_i) \in \preceq$, then $\psi_{x_i, x_j} \equiv x_i = x_j$, otherwise, if $(x_i, x_j) \in \preceq$ and $(x_j, x_i) \not \in \preceq$, then $\psi_{x_i, x_j} \equiv x_i < x_j$, otherwise, $\psi_{x_i, x_j} \equiv x_i > x_j$. 

%$g \wedge g'$ is satisfiable, and for each pair of control variables $x_i, x_j \in X$, if $g \wedge g' \models x_i = x_j$ (resp. $g \wedge g' \models x_i < x_j$), then $f(x_i)=f(x_j)$ (resp. $(x_i, x_j) \in \preceq$).
%
% one of the following conditions,
%\begin{itemize}
%\item $g'$ is of the form $\cur  = x_i$ for some $x_i \in X$,
%
%\item $g'$ is of the form $\cur > x_j \wedge \cur < x_i$ for some $x_i, x_j \in X$ such that $x_i$ is the $\preceq$-successor of $x_j$. Let $\preceq'_1$ be the reflexive and transitive closure of $\preceq \cup \{(x_j, \cur), (\cur, x_i)\}$.
%\end{itemize} 
%
%\item $g \wedge g'$ is satisfiable.
%
\item $\preceq'$ is constructed as follows.
\begin{itemize}
\item Case $g' \equiv \cur = x_i$: At first, for each $x_{i'} \in X$, introduce a fresh variable $x'_{i'}$ to denote the value of $x_{i'}$ after the transition $(q, g, \eta,q)$. Let $X'$ denote the set of fresh variables. Let $\preceq''$ be the reflexive and transitive closure of the relation
\[
\begin{array}{l}
\preceq \cup\ \{(x_{i'}, x'_{i'}), (x'_{i'}, x_{i'}) \mid x_{i'} \in X \setminus \dom(\eta)\}\ \cup\ \{(\cur, x_i), (x_i, \cur)\}\ \cup \\
 \{(x_{i'}, x'_{i''}), (x'_{i''}, x_{i'}) \mid \eta(x_{i'})=x_{i''}\} \cup \{(x'_{i'}, \cur), (\cur, x'_{i'}) \mid \eta(x_{i'}) = \cur \}.
\end{array}
\] 
Then $\preceq'$ is the total preorder obtained from $\preceq'' \ \cap\ X' \times X'$ by replacing each $x'_i \in X'$ with $x_i \in X$.

\item Case $g' \equiv \cur > x_j \wedge \cur < x_i$, or $g' \equiv  \cur > x_i$, or $g' \equiv \cur < x_i$:
At first, for each $x_{i'} \in X$, introduce a fresh variable $x'_{i'}$ to denote the value of $x_{i'}$ after the transition $(q, g, \eta,q)$. Let $X'$ denote the set of fresh variables. Let $\preceq''$ be the reflexive and transitive closure of the relation
\[
\begin{array}{l}
\preceq \cup\ \{(x_{i'}, x'_{i'}), (x'_{i'}, x_{i'}) \mid x_{i'} \in X \setminus \dom(\eta)\}\ \cup\ \{(x_j, \cur), (cur, x_i)\}\ \cup \\
\{(x_{i'}, x'_{i''}), (x'_{i''}, x_{i'}) \mid \eta(x_{i'})=x_{i''}\} \cup \{(x'_{i'}, \cur), (\cur, x'_{i'}) \mid \eta(x_{i'}) = \cur \}.
\end{array}
\] 
Then $\preceq'$ is the total preorder obtained from $\preceq'' \ \cap\ X' \times X'$ by replacing each $x'_i \in X'$ with $x_i \in X$.
\end{itemize}
%
%\item Case $g' \equiv \cur > x_i$: 
%
%\item Case $g' \equiv \cur < x_i$: 
\end{itemize}

\item For each $(q, g \wedge \cur = \triangleright, \eta, q') \in \delta$, $\delta'$ includes all the transitions $(q, \preceq) \xrightarrow{(\cur = \triangleright, \eta)} (q', \preceq')$ satisfying the following constraints.
\begin{itemize}
\item $\preceq$ and $g$ are compatible, more precisely, $\varphi_{\preceq} \wedge g$ is satisfiable, where $\varphi_{\preceq} \equiv \bigwedge \limits_{ i< j} \psi_{x_i, x_j}$, and for each pair of indices $i, j \in [k]$ such that $i < j$, $\psi_{x_i, x_j}$ is defined as above. 
%
\item $\preceq'$ is constructed as follows.
At first, for each $x_{i'} \in X$, introduce a fresh variable $x'_{i'}$ to denote the value of $x_{i'}$ after the transition $(q, g \wedge \cur = \triangleright, \eta, q)$. Let $X'$ denote the set of fresh variables. Let $\preceq''$ be the reflexive and transitive closure of the relation
$
%\begin{array}{l}
\preceq \cup\ \{(x_{i'}, x'_{i'}), (x'_{i'}, x_{i'}) \mid x_{i'} \in X \setminus \dom(\eta)\}  \cup 
%\\
 \{(x_{i'}, x'_{i''}), (x'_{i''}, x_{i'}) \mid \eta(x_{i'})=x_{i''}\}.
%\end{array}
$ 
Then $\preceq'$ is the total preorder obtained from $\preceq'' \ \cap\ X' \times X'$ by replacing each $x'_i \in X'$ with $x_i \in X$.
\end{itemize}
\end{itemize}

At first, from the construction, we know that $\Ss'$ is path-feasible, state-dominating, and $\triangleright$-transition-guard-tree. We then show that $\Ss'$ is generalized-flat. It is sufficient to prove that for each state $q$ in some nontrivial SCC $S$ of $\Ss$, there does not exist a nontrivial SCC in $\Ss'$ that includes at least two distinct states $(q, \preceq_1)$ and $(q, \preceq_2)$.

To the contrary, suppose that there are a state $q$ in some nontrivial SCC $S$ of $\Ss$ and two distinct states $(q, \preceq_1)$ and $(q, \preceq_2)$ in some nontrivial SCC of $\Ss'$.

Since $\preceq_1 \neq \preceq_2$, without loss of generality, we assume that there are a pair of distinct control variables $x_i, x_j$ such that $(x_i, x_j) \in \preceq_1$ and $(x_i, x_j) \not \in \preceq_2$. 
We introduce some notations first. For $x \in \{x_i, x_j\}$, we say that $x$ computes the minimum (resp. maximum) value in $S$ if whenever $\cur < x$ (resp. $\cur > x$) occurs in a transition $(q, g, \eta, q)$ of $S$, it holds that $\eta(x)=\cur$. 
We distinguish between the following situations.
\begin{itemize}
\item Suppose that both $x_i$ and $x_j$ compute the minimum value in $S$. Since both $x_i$ and $x_j$ compute the minimum value in $S$, when starting from some configuration $(q, \rho)$ such that $\rho \models x_i \le x_j$ and keep applying the transitions in $S$, we know that in each transition, 
\begin{itemize}
\item either the current data value is less or equal to both $x_i$ and $x_j$, then both $x_i$ and $x_j$ are assigned to the current data value and become equal, 
%
\item or the current data value is greater than $x_i$ and less or equal to $x_j$, then the current data value is assigned to $x_j$ (with the value of $x_i$ unchanged), then $x_i < x_j$ holds after the transition,
%
\item or the current data value is greater than both $x_i$ and $x_j$, then both the value of $x_i$ and that of $x_j$ are unchanged.
\end{itemize}
Therefore, when following a path from $(q, \preceq_1)$ to $(q, \preceq_2)$ in $\Ss'$, the fact $x_i \le x_j$ persists. This implies that $(x_i, x_j) \in \preceq_2$, a contradiction.
%
\item Suppose that both $x_i$ and $x_j$ compute the maximum value in $S$. Similarly to the arguments in the previous situation, we know that when following a path from $(q, \preceq_1)$ to $(q, \preceq_2)$ in $\Ss'$, the fact $x_i \le x_j$ persists. This implies that $(x_i, x_j) \in \preceq_2$, a contradiction.
%
\item Suppose that $x_i$ computes the minimum value in $S$ and $x_j$ computes the maximum value in $S$. Since $x_i$ computes the minimum value and $x_j$ computes the maximum value in $S$, we know that the value of $x_i$ is non-increasing and the value of $x_j$ is non-decreasing. Therefore, when following a path from $(q, \preceq_1)$ to $(q, \preceq_2)$, the fact $x_i \le x_j$ persists. This implies that $(x_i, x_j) \in \preceq_2$, a contradiction.
%
\item Suppose that $x_i$ computes the minimum value in $S$ and $x_j$ computes neither the minimum value nor the maximum value in $S$. Then the value of $x_i$ is non-increasing and the value of $x_j$ is unchanged when staying in $S$. The arguments are similar to the previous case.
%
\item Suppose that $x_i$ computes neither the minimum value nor the maximum value and $x_j$ computes the maximum value in $S$. Then the value of $x_i$ is unchanged and the value of $x_j$ is non-decreasing when staying in $S$. The arguments are similar to the previous case.
%
\item Suppose that $x_i$ computes the maximum value in $S$ and $x_j$ computes the minimum value in $S$.  Then in $S$, the value of $x_i$ is non-decreasing and the value of $x_j$ is non-increasing.  From $(x_i, x_j) \in \preceq_1$ and $(x_i, x_j) \not \in \preceq_2$, we know that when following a path from $(q, \preceq_1)$ to $(q, \preceq_2)$ in $\Ss'$, sometime the value of $x_i$ becomes strictly greater than that of $x_j$, and this fact persists afterwards. Therefore, we have $(x_j, x_i) \in \preceq_2$ and $(x_i, x_j) \not \in \preceq_2$. Since in $S$, the value of $x_i$ is non-decreasing and the value of $x_j$ is non-increasing, we know that when following a path from $(q, \preceq_2)$ to $(q, \preceq_1)$ in $\Ss'$, $x_j < x_i$ persists. Therefore, $(x_j, x_i) \in \preceq_1$ and $(x_i, x_j) \not \in \preceq_1$, a contradiction.
%
\item Suppose that $x_i$ computes the maximum value and  $x_j$ computes neither the minimum value nor the maximum value in $S$. Then the value of $x_i$ is non-decreasing and the value of $x_j$ is unchanged when staying in $S$. The arguments are similar to the previous case.
%
\item Suppose that $x_i$ computes neither the minimum value nor the maximum value in $S$ and $x_j$ computes the minimum value in $S$. Then the value of $x_i$ is unchanged and the value of $x_j$ is non-increasing when staying in $S$. The arguments are similar to the previous case.
%
\item Suppose $x_i$ (resp. $x_j$) computes neither  the minimum value nor the maximum value in $S$. Then the value of $x_i$ and $x_j$ are unchanged when staying in $S$. Therefore, if $x_i \le x_j$ holds in the state $(q, \preceq_1)$, then it holds in each state belonging to the same SCC as $(q, \preceq_1)$ in $\Ss'$. In particular, $(x_i, x_j) \in \preceq_2$, a contradiction.
\end{itemize}
Consequently, in each of the situations aforementioned, we always get a contradiction. 
%
We conclude that the assumption is false and $\Ss'$ is indeed generalized-flat.
\hide{
In the following, we transform $\Ss''$ into an SNT $\Ss' = (Q', X, Y, \delta', q'_0, O')$ which has the same set of states and the same transition graph as $\Ss''$, but becomes storage-irredundant, and thus normalized. More specifically, 
$Q' = Q''$ and
$q'_0 = q''_0$.
In addition, $O'$ is obtained from $O''$ as follows: Let $(q, \preceq) \in Q''$ such that $O''((q, \preceq))$ is defined, then $O'((q, \preceq))$ is obtained from $O''((q, \preceq))$ by replacing each control variable $x_i \in X$ with $x_j \in X$, where $x_j$ is the control variable of the \emph{minimum} index such that $(x_i, x_j), (x_j, x_i) \in \preceq$. Finally, $\delta'$ are obtained from $\delta''$ as follows: For each transition $(q, \preceq) \xrightarrow{(g,\eta)} (q, \preceq') \in \delta''$, let $(q, \preceq) \xrightarrow{(g', \eta')} (q, \preceq') \in \delta'$, where 
\begin{itemize}
\item $g'$ is obtained from $g$ by replacing each $x_i \in X$ with $x_j \in X$, where $x_j$ is the control variable of the \emph{minimum} index such that $(x_i, x_j), (x_j, x_i) \in \preceq$, 
\item 
$\eta'$ is obtained from $\eta$ as follows: for each $x_i \in \dom(\eta)$, if there is $x_j \in X$ such that $j < i$ and $(x_i, x_j), (x_j, x_i) \in \preceq'$, then $\eta'(x_i)$ is undefined, otherwise, $\eta'(x_i) = \eta(x_i)$.
\end{itemize}
The intuition of the construction of $g', \eta'$ is as follows: When $x_i$ is replaced by $x_j$ in $g$, $x_i$ is not referred to any more in the guard of any transition out of the state $(q, \preceq)$, which makes it possible to remove the redundancy of the assignments $\eta$.
}
\qed
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\hide{
\noindent {\bf Proposition~\ref{prop-snt-norm}}.
{
For each SNT $\Ss$, the nonzero-output problem of $\Ss$ can be reduced to a series of the nonzero-output problems of normalized SNTs $\Ss'$ in exponential time.
}
\smallskip

\newcommand{\lo}{\mathsf{LO}}

\newcommand{\fn}{\mathsf{FN}}

\begin{proof}
Suppose $\Ss = (Q, X, Y, \delta, q_0, O)$ is an SNT such that $X=\{x_1,\dots, x_k\}$. Our goal is to reduce the nonzero-output problem of $\Ss$ to a series of  nonzero-output problems of normalized SNTs $\Ss'  = (Q', X, Y, \delta', q'_0, O')$.

%Without loss of generality, we assume that the set of write-once control variables of $\Ss$ satisfies that $X_{\sf w} = \{x_1,\dots, x_{k'} \}$ for some $k' \ge 0$ (If $k'=0$, then $X_{\sf w} = \emptyset$).

%We divide the reduction into two steps. At first, we construct a collection of SNTs $\Ss'' = (Q'', X, Y, \delta'', q''_0, O'')$ that are path-feasible and state-dominating, but not necessarily storage-irredundant. Then, we transform each SNT $\Ss''$ into a normalized $\Ss'$.

Let $\lo_{X}$ denote the set of linear orders between control variables (Recall that a linear order over $X$ is partial order $\preceq$  over $X$ such that for each $x_i, x_j \in X$, either $(x_i, x_j) \in \preceq$ or $(x_j, x_i) \in \preceq$). For $\preceq \in \lo_X$ and $x_i, x_j \in X$,  $x_i$ is said to be the \emph{$\preceq$-successor} of  $x_j$ or $x_j$ is said to be the \emph{$\preceq$-predecessor} of $x_i$, if $(x_j, x_i) \in \preceq$, $(x_i, x_j) \not \in \preceq$, and for each $x_{i'} \in X$ such that $(x_j, x_{i'}) \in \preceq$, it holds that $(x_i, x_{i'}) \in \preceq$. In addition, let $\fn_X$ denote the set of functions over $X$.

Then for each $\preceq_0 \in \lo_X$, we construct an SNT $\Ss'= (Q', X, Y, \delta', q'_0, O')$ as follows: $Q'= Q \times \fn_X \times \lo_X$, and $q'_0=(q_0, f_0, \preceq_0)$, where $f_0(x_i)=x_i$ for each $x_i \in X$. Moreover, $O'$ is defined as follows: For each $(q, f, \preceq) \in Q'$, $O'((q, f, \preceq)) = f(O(q))$, where $f(O(q))$ is the expression obtained from $O(q)$ by replacing simultaneously each $x_i \in X$ with $f(x_i)$. It remains to define $\delta'$.

The transition set $\delta'$ is defined by the following rules, 
For each $(q, g, \eta, q') \in \delta$, $\delta'$ includes all the transitions $(q, f, \preceq) \xrightarrow{(g', \eta')} (q', f', \preceq')$ satisfying the following constraints. 
\begin{itemize}
\item  $g'$ is of the form $\cur = x_i$ where $x_i \in X$, or of the form $\cur > x_j \wedge \cur < x_i$ such that $x_i \in X$ is the $\preceq$-successor of $x_j \in X$, or of the form $\cur > x_i$ such that there does not exist the $\preceq$-successor of $x_i$, or of the form $\cur < x_i$ such that there does not exist the $\preceq$-predecessor of $x_i$.
%
\item $f$, $\preceq$, $g$ and $g'$ are compatible, more precisely, $\varphi_{f, \preceq} \wedge g \wedge g'$ is satisfiable, where $\varphi_{f, \preceq} \equiv \bigwedge \limits_{x_i \neq x_j} \psi_{x_i, x_j}$, and for each pair of distinct variables $x_i, x_j \in X$,  if $f(x_i) = f(x_j)$, then $\psi_{x_i, x_j} \equiv x_i = x_j$, otherwise, if $(f(x_i), f(x_j)) \in \preceq$, then $\psi_{x_i, x_j} \equiv x_i < x_j$, otherwise, $\psi_{x_i, x_j} \equiv x_i > x_j$. 

%$g \wedge g'$ is satisfiable, and for each pair of control variables $x_i, x_j \in X$, if $g \wedge g' \models x_i = x_j$ (resp. $g \wedge g' \models x_i < x_j$), then $f(x_i)=f(x_j)$ (resp. $(x_i, x_j) \in \preceq$).
%
% one of the following conditions,
%\begin{itemize}
%\item $g'$ is of the form $\cur  = x_i$ for some $x_i \in X$,
%
%\item $g'$ is of the form $\cur > x_j \wedge \cur < x_i$ for some $x_i, x_j \in X$ such that $x_i$ is the $\preceq$-successor of $x_j$. Let $\preceq'_1$ be the reflexive and transitive closure of $\preceq \cup \{(x_j, \cur), (\cur, x_i)\}$.
%\end{itemize} 
%
%\item $g \wedge g'$ is satisfiable.
%
\item $\eta'$, $\preceq'$, and $f'$ are constructed as follows.
\begin{itemize}
\item Case $g' \equiv \cur = x_i$: Then let $\preceq' = \preceq$ and $\dom(\eta')=\emptyset$. In addition, $f'$ is constructed as follows:
for each $x_{i'} \in X$, 
\begin{itemize}
\item if $x_{i'} \in \dom(\eta)$ and $\eta(x_{i'}) = \cur$, then $f'(x_{i'}) = f(x_i)$, 
%
\item if $x_{i'} \in \dom(\eta)$ and $\eta(x_{i'}) = x_{i''}$, then $f'(x_{i'})=f(x_{i''})$,
%
\item if $x_{i'} \not \in \dom(\eta)$, then $f'(x_{i'})=f(x_{i'})$.
\end{itemize}

\item Case $g' \equiv \cur > x_j \wedge \cur < x_i$, or $g' \equiv  \cur > x_i$, or $g' \equiv \cur < x_i$:
\begin{itemize}
\item If there does not exist $x_{i'} \in \dom(\eta)$ such that $\eta(x_{i'})=\cur$, then let $\preceq' = \preceq$ and $\dom(\eta')=\emptyset$. In addition, $f'$ is constructed as follows: for each $x_{i'} \in X$, if $x_{i'} \in \dom(\eta)$ such that $\eta(x_{i'})=x_{i''}$, then let $f'(x_{i'})=f(x_{i''})$, otherwise, let $f'(x_{i'})=f(x_{i'})$.
%
\item Otherwise, the set of control variables whose original values should be preserved for the future use is $f((X \setminus \dom(\eta))  \cup (\rng(\eta) \cap X))$. Since $|\rng(\eta) \cap X| \le |\rng(\eta)|-1 \le |\dom(\eta)|-1$, we deduce that $|(X \setminus \dom(\eta))  \cup (\rng(\eta) \cap X)| \le |X|- |\dom(\eta)| +|\dom(\eta)|-1 = |X|-1$. Therefore, $|f((X \setminus \dom(\eta))  \cup (\rng(\eta) \cap X))| \le |X|-1$.
This implies that $f((X \setminus \dom(\eta))  \cup (\rng(\eta) \cap X))$ is a proper subset of $X$. Suppose $x_{i'_0}$ is the control variable of the minimum index such that $x_{i'_0} \in X \setminus f((X \setminus \dom(\eta))  \cup (\rng(\eta) \cap X))$. Let $\dom(\eta')=\{x_{i'_0}\}$ and $\eta'(x_{i'_0})=\cur$. Moreover, $\preceq'$ is obtained from $\preceq$ by first removing all pairs involving $x_{i'_0}$ (except $(x_{i'_0}, x_{i'_0})$), then adding the set of the following pairs $R$,
\begin{itemize}
\item if $g' \equiv \cur > x_j \wedge \cur < x_i$, then $R$ comprises the pairs $(x_{i'_0}, x_{i''})$ such that $(x_i, x_{i''}) \in \preceq$ and $x_{i''} \neq x_{i'_0}$, and the pairs $(x_{i''}, x_{i'_0})$ such that $(x_{i''}, x_j) \in \preceq$ and $x_{i''} \neq x_{i'_0}$,
%
\item if $g' \equiv \cur > x_i$, then $R$ comprises the pairs $(x_{i''}, x_{i'_0})$ such that $(x_{i''}, x_i) \in \preceq$ and $x_{i''} \neq x_{i'_0}$,
%
\item  if $g' \equiv \cur < x_i$, then $R$ comprises the pairs $(x_{i'_0}, x_{i''})$ such that $(x_i, x_{i''}) \in \preceq$ and $x_{i''} \neq x_{i'_0}$.
\end{itemize}
Finally, $f'$ is constructed as follows:
For each $x_{i'} \in X$, 
\begin{itemize}
\item if $x_{i'} \in \dom(\eta)$ and $\eta(x_{i'}) = \cur$, then $f'(x_{i'}) = x_{i'_0}$, 
%
\item if $x_{i'} \in \dom(\eta)$ and $\eta(x_{i'}) = x_{i''}$, then $f'(x_{i'})=f(x_{i''})$,
%
\item if $x_{i'} \not \in \dom(\eta)$, then $f'(x_{i'})=f(x_{i'})$.
\end{itemize}
%
\end{itemize}
\end{itemize}
%
%\item Case $g' \equiv \cur > x_i$: 
%
%\item Case $g' \equiv \cur < x_i$: 
\end{itemize}

At first, from the construction, we know that $\Ss'$ is path-feasible, state-dominating, storage-irredundant, and control-variable-copyless. We then show that $\Ss'$ is generalized-flat. It is sufficient to prove that for each state $q$ in some nontrivial SCC $S$ of $\Ss_0$, there does not exist a nontrivial SCC in $\Ss'$ that includes at least two distinct states $(q, f_1, \preceq_1)$ and $(q, f_2, \preceq_2)$.

To the contrary, suppose that there are a state $q$ in some nontrivial SCC $S$ of $\Ss_0$ and two distinct states $(q, f_1, \preceq_1)$ and $(q, f_2, \preceq_2)$ in some nontrivial SCC of $\Ss''$.

Since $\preceq_1 \neq \preceq_2$, without loss of generality, we assume that there are a pair of distinct control variables $x_i, x_j$ such that $(x_i, x_j) \in \preceq_1$ and $(x_i, x_j) \not \in \preceq_2$. Since the values of write-once control variables are unchanged in $S$, we deduce that either $x_i$ or $x_j$ is a normal control variable, that is,  in $X_{\sf n}$.
%We first assume that all the guards $\cur > x_1$, $\cur < x_1$, $\cur > x_2$ and $\cur < x_2$ occur in $S$. 
We introduce some notations first. For $x \in \{x_i, x_j\}$, we say that $x$ computes the minimum (resp. maximum) value in $S$ if whenever $\cur < x$ (resp. $\cur > x$) occurs in a transition $(q, g, \eta, q)$ of $S$, it holds that $\eta(x)=\cur$. 
We distinguish between the following situations.
\begin{itemize}
\item Suppose that both $x_i$ and $x_j$ compute the minimum value in $S$. Since both $x_i$ and $x_j$ compute the minimum value in $S$, when starting from some configuration $(q, \rho)$ such that $\rho \models x_i \le x_j$ and keep applying the transitions in $S$, we know that in each transition, 
\begin{itemize}
\item either the current data value is less or equal to both $x_i$ and $x_j$, then both $x_i$ and $x_j$ are assigned to the current data value and become equal, 
%
\item or the current data value is greater than $x_i$ and less or equal to $x_j$, then the current data value is assigned to $x_j$ (with the value of $x_i$ unchanged), then $x_i < x_j$ holds after the transition,
%
\item or the current data value is greater than both $x_i$ and $x_j$, then both the value of $x_i$ and that of $x_j$ are unchanged.
\end{itemize}
Therefore, when following a path from $(q, \preceq_1)$ to $(q, \preceq_2)$ in $\Ss'$, the fact $x_i \le x_j$ persists. This implies that $(x_i, x_j) \in \preceq_2$, a contradiction.
%
\item Suppose that both $x_i$ and $x_j$ compute the maximum value in $S$. Similarly to the arguments in the previous situation, we know that when following a path from $(q, \preceq_1)$ to $(q, \preceq_2)$ in $\Ss'$, the fact $x_i \le x_j$ persists. This implies that $(x_i, x_j) \in \preceq_2$, a contradiction.
%
\item Suppose that $x_i$ computes the minimum value in $S$ and $x_j$ computes the maximum value in $S$. Since $x_i$ computes the minimum value and $x_j$ computes the maximum value in $S$, we know that the value of $x_i$ is non-increasing and the value of $x_j$ is non-decreasing. Therefore, when following a path from $(q, \preceq_1)$ to $(q, \preceq_2)$, the fact $x_i \le x_j$ persists. This implies that $(x_i, x_j) \in \preceq_2$, a contradiction.
%
\item Suppose that $x_i$ computes the minimum value in $S$ and $x_j$ computes neither the minimum value nor the maximum value in $S$. Then the value of $x_i$ is non-increasing and the value of $x_j$ is unchanged when staying in $S$. The arguments are similar to the previous case.
%
\item Suppose that $x_i$ computes neither the minimum value nor the maximum value and $x_j$ computes the maximum value in $S$. Then the value of $x_i$ is unchanged and the value of $x_j$ is non-decreasing when staying in $S$. The arguments are similar to the previous case.
%
\item Suppose that $x_i$ computes the maximum value in $S$ and $x_j$ computes the minimum value in $S$.  Then in $S$, the value of $x_i$ is non-decreasing and the value of $x_j$ is non-increasing.  From $(x_i, x_j) \in \preceq_1$ and $(x_i, x_j) \not \in \preceq_2$, we know that when following a path from $(q, \preceq_1)$ to $(q, \preceq_2)$ in $\Ss'$, sometime the value of $x_i$ becomes strictly greater than that of $x_j$, and this fact persists afterwards. Therefore, we have $(x_j, x_i) \in \preceq_2$ and $(x_i, x_j) \not \in \preceq_2$. Since in $S$, the value of $x_i$ is non-decreasing and the value of $x_j$ is non-increasing, we know that when following a path from $(q, \preceq_2)$ to $(q, \preceq_1)$ in $\Ss'$, $x_j < x_i$ persists. Therefore, $(x_j, x_i) \in \preceq_1$ and $(x_i, x_j) \not \in \preceq_1$, a contradiction.
%
\item Suppose that $x_i$ computes the maximum value and  $x_j$ computes neither the minimum value nor the maximum value in $S$. Then the value of $x_i$ is non-decreasing and the value of $x_j$ is unchanged when staying in $S$. The arguments are similar to the previous case.
%
\item Suppose that $x_i$ computes neither the minimum value nor the maximum value in $S$ and $x_j$ computes the minimum value in $S$. Then the value of $x_i$ is unchanged and the value of $x_j$ is non-increasing when staying in $S$. The arguments are similar to the previous case.
%
\item Suppose $x_i$ (resp. $x_j$) computes neither  the minimum value nor the maximum value in $S$. Then the value of $x_i$ and $x_j$ are unchanged when staying in $S$. Therefore, if $x_i \le x_j$ holds in the state $(q, \preceq_1)$, then it holds in each state belonging to the same SCC as $(q, \preceq_1)$ in $\Ss'$. In particular, $(x_i, x_j) \in \preceq_2$, a contradiction.
\end{itemize}
Consequently, in each of the situations aforementioned, we always get a contradiction. 
%
We conclude that the assumption is false and $\Ss''$ is indeed generalized-flat.

In the following, we transform $\Ss''$ into an SNT $\Ss' = (Q', X, Y, \delta', q'_0, O')$ which has the same set of states and the same transition graph as $\Ss''$, but becomes storage-irredundant, and thus normalized. More specifically, 
$Q' = Q''$ and
$q'_0 = q''_0$.
In addition, $O'$ is obtained from $O''$ as follows: Let $(q, \preceq) \in Q''$ such that $O''((q, \preceq))$ is defined, then $O'((q, \preceq))$ is obtained from $O''((q, \preceq))$ by replacing each control variable $x_i \in X$ with $x_j \in X$, where $x_j$ is the control variable of the \emph{minimum} index such that $(x_i, x_j), (x_j, x_i) \in \preceq$. Finally, $\delta'$ are obtained from $\delta''$ as follows: For each transition $(q, \preceq) \xrightarrow{(g,\eta)} (q, \preceq') \in \delta''$, let $(q, \preceq) \xrightarrow{(g', \eta')} (q, \preceq') \in \delta'$, where 
\begin{itemize}
\item $g'$ is obtained from $g$ by replacing each $x_i \in X$ with $x_j \in X$, where $x_j$ is the control variable of the \emph{minimum} index such that $(x_i, x_j), (x_j, x_i) \in \preceq$, 
\item 
$\eta'$ is obtained from $\eta$ as follows: for each $x_i \in \dom(\eta)$, if there is $x_j \in X$ such that $j < i$ and $(x_i, x_j), (x_j, x_i) \in \preceq'$, then $\eta'(x_i)$ is undefined, otherwise, $\eta'(x_i) = \eta(x_i)$.
\end{itemize}
The intuition of the construction of $g', \eta'$ is as follows: When $x_i$ is replaced by $x_j$ in $g$, $x_i$ is not referred to any more in the guard of any transition out of the state $(q, \preceq)$, which makes it possible to remove the redundancy of the assignments $\eta$.
\qed
\end{proof}
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Proofs in Section~\ref{sec-sum}}


\noindent {\bf Proposition~\ref{prop-sum-path}}.
{\it Suppose that $P$ is a path and the initial values of $X \cup Y$ are represented by a symbolic valuation $\initval$. Then the values of $X \cup Y$ after traversing the path $P$ are specified by a symbolic valuation $\sumf^{(P,\initval)}$ satisfying the following conditions.
\begin{itemize}
\item The set of indices of $X$, i.e., $[k]$, is partitioned into $I^{\circled{P}}_{pe}$ and $I^{\circled{P}}_{tr}$, the indices of \emph{persistent} and \emph{transient} control variables, respectively. A control variable is persistent if its value has not been changed while traversing $P$, otherwise, it is transient.
\item For each $x_j\in X$ such that $j\in I^{\circled{P}}_{pe}$, $\sumf^{(P,\initval)}(x_j)=\sval(x_j)$.
%
\item  For each $x_j\in X$ such that $j\in I^{\circled{P}}_{tr}$,
$\sumf^{(P,\initval)}(x_j)=\vard^{\circled{P}}_{\pi^{\circled{P}}(j)}$, where $\pi^{\circled{P}}: I^{\circled{P}}_{tr} \rightarrow [r^{\circled{P}}]$ is an injective mapping from the index of a transient control variable to the index of the data value assigned to it.
% 
\item For each $y_j \in Y$, 
$
 \sumf^{(P,\initval)}(y_j)  =
 \cste^{\circled{P}}_{j} + 
 \cstl^{\circled{P}}_j \initval(y_j)  + 
  \sum\limits_{j'\in [k]}\csta^{\circled{P}}_{j,j'}\initval(x_{j'}) +
  \sum\limits_{j''\in [r^{\circled{P}}]}\cstb^{\circled{P}}_{j,j''} \vard^{\circled{P}}_{j''}$,
\hide{
\item For each $y_j \in Y$, 
\[
\small
\begin{array}{l}
\smallskip
\sumf^{(P,\initval)}(y_j)  = \\
\hspace{2mm} \cste^{\circled{P}}_{j} + \cstl^{\circled{P}}_j \initval(y_j)  + \csta^{\circled{P}}_{j,1} \initval(x_1) + \dots + \csta^{\circled{P}}_{j,k} \initval(x_k) +  \cstb^{\circled{P}}_{j,1} \vard^{\circled{P}}_1 +\dots + \cstb^{\circled{P}}_{j,r^{\circled{P}}} \vard^{\circled{P}}_{r^{\circled{P}}},
\end{array}
\]} 
where $\cste^{\circled{P}}_j,\cstl^{\circled{P}}_j, \csta^{\circled{P}}_{j,1},\dots,\csta^{\circled{P}}_{j,k}, \cstb^{\circled{P}}_{j,1},\dots,\cstb^{\circled{P}}_{j,r^{\circled{P}}}$ are integer constants such that $\cstl^{\circled{P}}_{j} \in \{0,1\}$ (as a result of the ``independently evolving and copyless'' constraint).  It can happen that $\cstl^{\circled{P}}_j =0$,  which means that $\initval(y_j)$ is irrelevant to $\sumf^{(P,\initval)}(y_j)$. Similarly for $\csta^{\circled{P}}_{j,1}=0$, and so on.
\end{itemize}
}

\begin{proof}
Suppose that $\Ss=(Q,X,Y, \delta,q_0,O)$ is an (normalized) SNT. Suppose that $P=p_0 \xrightarrow{(g_1,\eta_1)} p_1 \dots p_{n-1} \xrightarrow{(g_n,\eta_n)} p_{n}$ is a path of $\Ss$ and $\initval$ is a symbolic valuation representing the  initial values of the control and data variables.  When $P$ is traversed in a run of $\Ss$ over a data word $w$,  the data value in a position of $w$ may have to be equal or unequal to the initial value of some control variable or some other data value in $w$ that have been met before (enforced by the guards and assignments in $P$). Let $\sim$ denote the equivalence relation on $[n]$ induced by $P$ such that $i \sim j$ iff the guards and assignments on $P$ enforce that the data value in the $i$-th position of $w$ must equal to that in the $j$-th position of $w$. Assuming that there are $r^{\circled{P}}$ equivalence classes of $\sim$, we use the variables $\vard^{\circled{P}}_1,\vard^{\circled{P}}_2,\dots, \vard^{\circled{P}}_{r^{\circled{P}}}$ to denote the data values met when traversing $P$, one for each equivalence class. 

We show by an induction that for each $i: 1 \le i \le n$, a symbolic valuation $\sumf_i$ over $X^+ \cup Y$ can be constructed  to describe the value of $x_j$ (resp. $y_j$) after going through the first $i$ transitions of $P$. Moreover, an index set $I_i \subseteq [k]$ is computed as well.
%
\begin{itemize}
\item Let $\sumf_0=\initval[\vard^{\circled{P}}_1/\cur]$ and $I_0 = \emptyset$.
%
%\item For each $x_j \in X$, if $x_j \in \dom(\eta_1)$, then $e_{1,x_j}=d^{(1)}_1$, otherwise, $e_{1,x_j}=d^{(0)}_j$. For each $y_j \in Y$, if $y_j \in \dom(\eta_1)$, then $e_{1,y_j} = \theta_0(\eta_{1}(y_j))$,
%otherwise, $e_{1,y_j}=o_j$. 
%
\item Let $i: 1 \le i \le n$. 
\begin{itemize}
\item For each $x_j \in X$, if $x_j \in \dom(\eta_i)$, then $\sumf_i(x_j)=\sumf_{i-1}(\cur)$ and $I_i= I_{i-1} \cup \{j\}$, otherwise, $\sumf_i(x_j) = \sumf_{i-1}(x_j)$ and and $I_i= I_{i-1}$. If $i < n$, suppose  the data value in the $(i+1)$-th position is represented by $\vard^{\circled{P}}_s$ for $1 \le s \le r^{\circled{P}}$, then let $\sumf_i(\cur)=\vard^{\circled{P}}_s$. Otherwise, $\sumf_i(\cur)=\bot$.
%
\item For each $y_j \in Y$, if $y_j \in \dom(\eta_i)$, then $\sumf_i(y_j) = \eval{\eta_i(y_j)}{\sumf_{i-1}}$, otherwise, $\sumf_i(y_j) =\sumf_{i-1}(y_j)$.
%
%\item For each $x_{j} \in X$ (resp. $y_j \in Y$), $\theta_i(x_{j})=e_{i,x_{j}}$ (resp. $\theta_i(y_{j})=e_{i, y_{j}}$). If $i < n$, then $\theta_i(\cur)=d^{(1)}_{s}$, where $1\le s \le r$ and $k+i + 1 \in I_s$, otherwise, $\theta_i(\cur)=\bot$.
\end{itemize} 
\end{itemize}
Then let $I^{\circled{P}}_{tr}:=I_n$ and $I^{\circled{P}}_{pe}:=[k] \setminus I^{\circled{P}}_{tr}$. The injective mapping $\pi^{\circled{P}}$ is defined as follows: For each $j \in I^{\circled{P}}_{tr}$, there is $s \in [r^{\circled{P}}]$ such that $\sumf_n(x_j)=\vard^{\circled{P}}_{s}$, let $\pi^{\circled{P}}(j)=s$. The symbolic valuation $\sumf^{(P,\initval)}$ can be defined as the restriction of $\sumf_n$ to $X \cup Y$. Since for each assignment $\eta_i$ and $y_j \in Y$, $\eta_i(y_j) = e$ or $\eta_i(y_j) = y_j +e$ for $e \in \Ee_{X^+}$, it follows that $\sumf^{(P,\initval)}(y_j)$ is of the form required by the proposition.
\qed
\end{proof}


\noindent {\bf Proposition~\ref{prop-sum-cycle}}.
{\it 
Suppose that $C$ is a cycle and $P=C^{\ell}$ such that $\ell \ge 2$. Then the symbolic valuation $\sumf^{(C^\ell,\initval)}$ to summarize the computation of $\Ss$ on $P$ is as follows,\medskip\\
\resizebox{\hsize}{!}{
$\begin{array}{l c l}
\sumf^{(C^\ell,\initval)}(y_j)  & = & 
\left(1 + \cstl^{\circled{C}}_{j} + \dots +(\cstl^{\circled{C}}_{j})^{\ell - 1} \right)\cste^{\circled{C}}_{j} + (\cstl^{\circled{C}}_{j})^\ell \initval(y_j) + \smallskip\\
%
& & \sum \limits_{j' \in I^{\circled{C}}_{pe}} \left(1+\cstl^{\circled{C}}_{j} + \dots +(\cstl^{\circled{C}}_{j})^{\ell - 1} \right) \csta^{\circled{C}}_{j,j'}\initval(x_{j'}) +  \sum \limits_{j' \in I^{\circled{C}}_{tr}}  (\cstl^{\circled{C}}_{j})^{\ell - 1} \csta^{\circled{C}}_{j,j'} \initval(x_{j'}) +  \\
%
& & \sum \limits_{j' \in \rng(\pi^{\circled{C}})} \sum \limits_{m\in[\ell -1]}
\left(  \csta^{\circled{C}}_{j, (\pi^{\circled{C}})^{-1}(j')} +(\cstl^{\circled{C}}_{j})\cstb^{\circled{C}}_{j,j'} \right)
(\cstl^{\circled{C}}_{j})^{\ell-m-1}
\vard^{\circled{C , m}}_{j'} +\\
%
& & \sum \limits_{j' \in [r^{\circled{C}}] \setminus \rng(\pi^{\circled{C}})}\sum \limits_{m\in[\ell -1]} \left((\cstl^{\circled{C}}_{j})^{\ell - m} \cstb^{\circled{C}}_{j,j'} \right) \vard^{\circled{C , m}}_{j'} + 
\sum \limits_{j' \in [r^{\circled{C}}] }  
 \cstb^{\circled{C}}_{j, j'} \vard^{\circled{C , \ell}}_{j'},
\end{array} 
$}\medskip\\
where the variables $\vard^{\circled{C , m}}_{1},\dots, \vard^{\circled{C , m}}_{r^{\circled{C}}}$ for $m\in [\ell-1]$
 represent the data values introduced when traversing $C$ for the $m$-th time.
}

%
\begin{proof}
We prove by an induction on $\ell$ that $\sumf^{(C^\ell,\initval)}(y_j)$ is of the desired form required by the proposition.

\noindent The induction base: $\ell=2$.

\smallskip

Let $\vard^{(\circled{C, 2})}_{1}, \dots, \vard^{(\circled{C, 2})}_{r^{\circled{C}}}$ be the data values introduced when traversing the cycle for the second time. Then from Corollary~\ref{cor-comp-two-paths}, we know that $\sumf^{(C^{2},\initval)} = \sumf^{(C,\sumf^{(C,\initval)})}$ is defined as follows: For each $y_j \in Y$,

\[
\begin{array}{rl}
	\medskip
	\sumf^{(C^{2},\initval)}(y_j) = & 
	\left(\cste^{\circled{C}}_{j}+
	\cstl^{\circled{C}}_{j} \cste^{\circled{C}}_{j}\right)+ \left(\cstl^{\circled{C}}_{j}\right)^2 \initval(y_j)+ \sum \limits_{j' \in I^{\circled{C}}_{pe}} 
	\left(1+\cstl^{\circled{C}}_{j}\right)  \csta^{\circled{C}}_{j,j'} \initval(x_{j'}) +\\
	\medskip
	& 
	\sum \limits_{j' \in  I^{\circled{C}}_{tr}} 
	 \cstl^{\circled{C}}_{j} \csta^{\circled{C}}_{j,j'}  \initval(x_{j'}) +
	\sum \limits_{j' \in \rng(\pi^{\circled{C}})} \left( \csta^{\circled{C}}_{j,(\pi^{\circled{C}})^{-1}(j')}+\cstl^{\circled{C}}_{j} \cstb^{\circled{C}}_{j,j'} \right) \vard^{\circled{C,1}}_{j'} + 
	 \\
	%
	\smallskip
	& 
	\sum \limits_{j' \in [r^{\circled{C}}]\setminus \rng(\pi^{\circled{C}})} \left( \cstl^{\circled{C}}_{j} \cstb^{\circled{C}}_{j,j'} \right) \vard^{\circled{C,1}}_{j'} +
	
	\sum \limits_{j'\in[r^{\circled{C}}]} \cstb^{\circled{C}}_{j,j'} \vard^{\circled{C,2}}_{j'}.
\end{array}
\]

\noindent Induction step: Let $\ell \ge 3$.

From the induction hypothesis, we know that for each $y_j \in Y$, $\sumf^{(C^{\ell-1},\initval)}(y_j)$ is of the desired form.

From Corollary~\ref{cor-comp-two-paths}, $\sumf^{(C^\ell,\initval)} = \sumf^{(C, \sumf^{(C^{\ell-1},\initval)})}$. Then for each $y_j \in Y$, by unfolding the expressions $\sumf^{(C^{\ell-1},\initval)}(x_{j'})$ for $j' \in [k]$ and $\sumf^{(C^{\ell-1},\initval)}(y_{j''})$ for $j'' \in [l]$ in $\sumf^{(C, \sumf^{(C^{\ell-1},\initval)})}(y_j)$, we can observe that $\sumf^{(C^\ell,\initval)}(y_j)$ is of the desired form.
\qed
\end{proof}

\section{Proofs in Section~\ref{sec-glasso}}



\noindent {\bf Lemma~\ref{prop-cycle-schm}}.
{\it 
Suppose $\schm=C_{i_1}^{\ell_1} C_{i_2}^{\ell_2} \dots C_{i_t}^{\ell_t}$ is a cycle scheme, and $\initval$ is a symbolic valuation representing the initial values of the control and data variables. 
For all $j' \in  I^{\circled{C_{i_{1}}}}_{pe}$, let $r_{j'}$ be the largest number $r \in [t]$ such that $j'\in\bigcap_{s\in[r]} I^{\circled{C_{i_{s}}}}_{pe}$, i.e., $x_{j'}$ remains persistent when traversing $C_{i_1}^{\ell_1} C_{i_2}^{\ell_2} \dots C_{i_{r_{j'}}}^{\ell_{r_{j'}}}$.
Then for each $j\in [l]$ and $j' \in  I^{\circled{C_{i_{1}}}}_{pe}$, the coefficient of the $\initval(x_{j'})$-atom in $\sumf^{(\schm,\initval)}(y_j)$ is 
\begin{center}
\resizebox{0.8\hsize}{!}{
$e+\sum\limits_{s_1\in[r_{j'}]}  
\left(1+\lambda^{\circled{C_{i_{s_1}}}}_{j} + \dots + (\lambda^{\circled{C_{i_{s_1}}}}_{j})^{\ell_{s_1}-1} \right) \csta^{\circled{C_{i_{s_1}}}}_{j,j'}\prod\limits_{{s_2}\in[{s_1}+1,t]}\left(\lambda^{\circled{C_{i_{s_2}}}}_{j}\right)^{\ell_{s_2}}$},
\end{center}
where (1) $e\!=\!0$ when $r_{j'}\!=\!t$ and (2) $e=(\lambda^{\circled{C_{i_s}}}_{j})^{\ell_s-1} \csta^{\circled{C_{i_{s}}}}_{j,j'}$ with $s=r_{j'}+1$ when $r_{j'}<t$.\\
The constant atom of $\sumf^{(\schm,\initval)}(y_j)$ is 
\begin{center}
\resizebox{0.7\hsize}{!}{$
\sum\limits_{{s_1}\in[t]}
\left(1+\lambda^{\circled{C_{i_{s_1}}}}_{j} + \dots + (\lambda^{\circled{C_{i_{s_1}}}}_{j})^{\ell_{s_1}-1} \right)
\cste^{\circled{C_{i_{s_1}}}}_{j} 
\prod\limits_{{s_2}\in[{s_1}+1,t]}\left(\lambda^{\circled{C_{i_{s_2}}}}_{j}\right)^{\ell_{s_2}}$}
\end{center}
Moreover, for all $j\!\in\! [l]$, in $\sumf^{(\schm,\initval)}(y_j)$, only the constant atom and the coefficients of the $\initval(x_{j'})$-atoms with $j' \!\in\!I^{\circled{C_{i_{1}}}}_{pe}$ contain a subexpression of the form $ \mu_\schm \ell_1$ for some~$\mu_\schm\in \intnum$.
}

\begin{proof}
The lemma can be shown by applying Proposition~\ref{prop-sum-cycle}, Corollary~\ref{cor-comp-two-paths}, and an induction on the length $t$ of the cycle schemes.\qed
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\hide
{
\smallskip

\noindent {\bf Lemma~\ref{prop-bnd-domain-2}}.
{\it 
Suppose that the decision procedure has not returned yet after Step II. 
For all cycle scheme $\schm$ and $y_j \in Y$, the constant atom and the coefficients of all non-constant atoms in ${\sumf^{(\schm, \sumf^{(H,\initval_\bot)})}}^-(y_j)$ are from a finite set $U \subset \intnum$ comprising \\ (1)
the constant atom and the coefficients of the non-constant atoms in the expression ${\sumf^{(C^{\ell_i}_{i}, \sumf^{(H,\initval_\bot)})}}^-(y_j)$ for $i\in [n]$ and $\ell_i \in \{1,2\}$,\smallskip\\(2) the numbers $\csta^{\circled{C_{s_2}}}_{j,j'} + \cstb^{\circled{C_{s_1}}}_{j,\pi^{\circled{C_{s_1}}}(j')}$ and $\csta^{\circled{C_{s_1}}}_{j, j''} + \csta^{\circled{C_{s_2}}}_{j,j''}$, where  $s_1,s_2 \in [n], j\in[l],j' \in I^{\circled{C_{s_1}}}_{tr} \cap I^{\circled{C_{s_2}}}_{tr},  j'' \in [k]$. 
}

\begin{proof}
For each cycle scheme $\schm=C^{\ell_1}_{i_1} \dots C^{\ell_t}_{i_t}$ and each $y_j \in Y$, suppose for each $s\in [t]$, the data values introduced when traversing $C_{i_s}^{\ell_s}$ in $\schm$ are represented by the variables $\vard^{\circled{C_{i_s} , 1}}_{s,1}$, $\dots$, $\vard^{\circled{C_{i_s} , 1}}_{s,r^{\circled{C_{i_s}}}}$, $\dots$, $\vard^{\circled{C_{i_s} , \ell_s}}_{s,1}$, $\dots$, $\vard^{\circled{C_{i_s} , \ell_s}}_{s,r^{\circled{C_{i_s}}}}$. Then for each $y_j \in Y$,
 ${\sumf^{(\schm,\sumf^{(H,\initval_\bot)})}}^-(y_j)$ is a linear combination of $\vard^{\circled{H}}_1$, $\dots$, $\vard^{\circled{H}}_{r^{\circled{H}}}$, $\vard^{\circled{C_{i_1} , 1}}_{1,1}$, $\dots$, $\vard^{\circled{C_{i_1} , \ell_1}}_{1,r^{\circled{C_{i_1}}}}$, $\dots$, $\vard^{\circled{C_{i_t} , 1}}_{t,1}$, $\dots$, $\vard^{\circled{C_{i_t} , \ell_t}}_{t, r^{\circled{C_{i_t}}}}$. 

Suppose for each $y_j \in Y$,
\[
\begin{array}{l cl }
{\sumf^{(\schm,\sumf^{(H,\initval_\bot)})}}^-(y_j) &:= & (\cste^{\circled{\schm}}_{j})'  + (\csta^{\circled{\schm}}_{j,1})' \vard^{\circled{H}}_1 + \dots + (\csta^{\circled{\schm}}_{j,r^{\circled{H}}})' \vard^{\circled{H}}_{r^{\circled{H}}} + \\
& & (\cstb^{\circled{\schm,1}}_{1,1})' \vard^{\circled{C_{i_1},1}}_{1,1}  + \dots + (\cstb^{\circled{\schm,\ell_1}}_{1,r^{\circled{C_{i_1}}}})' \vard^{\circled{C_{i_1},\ell_1}}_{1,r^{\circled{C_{i_1}}}}  +  \\
& & \dots + \\
& & (\cstb^{\circled{\schm,1}}_{t,1})' \vard^{\circled{C_{i_{t}},1}}_{t,1} + \dots + (\cstb^{\circled{\schm,\ell_{t}}}_{t,r^{\circled{C_{i_{t}}}}})' \vard^{\circled{C_{i_{t}},\ell_{t}}}_{t, r^{\circled{C_{i_{t}}}}}.
\end{array}
\]

In the following, we show by induction on $t$ that for each cycle scheme $\schm=C^{\ell_1}_{i_1} \dots C^{\ell_t}_{i_t}$ and $y_j \in Y$, the following results hold.
\begin{enumerate}
\item In ${\sumf^{(\schm,\sumf^{(H,\initval_\bot)})}}^-(y_j)$, the constant atom and all the coefficients of the non-constant atoms are from $U$.
%
\item For each $\vard^{\circled{H}}_{j'}$ such that ${\sumf^{(\schm,\sumf^{(H,\initval_\bot)})}}^-(x_{j''})=\vard^{\circled{H}}_{j'}$ for some $j''  \in [k]$, the following fact holds: if there is $s \in [t]$ such that $\cstl^{\circled{C_{i_s}}}_j =0$, let $s_0$ be the maximum $s$ satisfying the constraint, then $(\csta^{\circled{\schm}}_{j,j'})'=\csta^{\circled{C_{i_{s_0}}}}_{j, j''}$, otherwise, $(\csta^{\circled{\schm}}_{j,j'})'= \beta^{\circled{H}}_{j,j'}$.
%
\item For each $s \in [t]$, $i \in [\ell_s]$, and $j' \in [r^{\circled{C_{i_s}}}]$ such that ${\sumf^{(\schm,\sumf^{(H,\initval_\bot)})}}^-(x_{j''})=\vard^{\circled{\schm, i}}_{s, j'}$ for some $j''  \in [k]$, it holds that $i = \ell_s$, $j'' \in I^{\circled{C_{i_s}}}_{tr}$, $j'' \in I^{\circled{C_{i_{s'}}}}_{pe}$ for each $s': s < s' \le t$, and the following fact holds: if there is $s': s < s' \le t$ such that $\cstl^{\circled{C_{i_{s'}}}}_j =0$, let $s'_0$ be the maximum $s'$ satisfying the constraint, then $(\cstb^{\circled{\schm, i}}_{j,j'})'=\csta^{\circled{C_{i_{s'_0}}}}_{j, j''}$, otherwise, $(\cstb^{\circled{\schm, i}}_{j,j'})'= \cstb^{\circled{C_{i_s}}}_{j,j'}$. 
\end{enumerate}

Induction base: $t=1$. 
\begin{itemize}
\item The first result: Follow from the definition of $U$. 

\item The second result: If $\cstl^{\circled{C_{i_1}}}_j = 0$, then $(\csta^{\circled{\schm}}_{j,j'})'=\csta^{\circled{C_{i_{1}}}}_{j, j''}$,  otherwise, $(\csta^{\circled{\schm}}_{j,j'})'=0$, since the expression $\csta^{\circled{C_{i_1}}}_{j,j''} \ell_1$ is removed from the coefficient of the $\sumf^{(H,\initval_\bot)}(x_{j''})$-atom in $\sumf^{(C^{\ell_1}_{i_1},\sumf^{(H,\initval_\bot)})}(y_j)$, i.e. the $\vard^{\circled{H}}_{j'}$-atom in $\sumf^{(C^{\ell_1}_{i_1},\sumf^{(H,\initval_\bot)})}(y_j)$. 

\item The third result: Suppose that $(\sumf^{(C^{\ell_1}_{i_1},\sumf^{(H,\initval_\bot)})})'(x_{j''})=\vard^{\circled{C_{i_1}, i}}_{1, j'}$ for $i \in [\ell_1]$, $j' \in [r^{\circled{C_{i_1}}}]$, and $j'' \in [k]$. Then $j'' \in I^{\circled{C_{i_1}}}_{tr}$, otherwise, $\vard^{\circled{C_{i_1}, i}}_{1, j'}$ would not be assigned to $x_{j''}$. From this, we deduce that $i = \ell_s$. Moreover, $(\csta^{\circled{C^{\ell_1}_{i_1}}}_{j,j'})'= \cstb^{\circled{C_{i_1}}}_{j,j'}$. 
\end{itemize}

Induction step: Suppose $t \ge 2$ and $\schm=C^{\ell_1}_{i_1} \dots C^{\ell_t}_{i_t}$.

Let $\schm_1= C^{\ell_1}_{i_1} \dots C^{\ell_{t-1}}_{i_{t-1}}$.  Then for each $y_j \in Y$, 
\[{\sumf^{(\schm,\sumf^{(H,\initval_\bot)})}}^-(y_j)=
{\sumf^{(C^{\ell_t}_{i_t},\ {\sumf^{(\schm_1, \sumf^{(H,\initval_\bot)})}}^-)}}^-(y_j).\] 

By the induction hypothesis, the three results hold for ${\sumf^{(\schm_1, \sumf^{(H,\initval_\bot)})}}^-$.

We illustrate the arguments for the case $\cstl^{\circled{C_{i_t}}}_{j} = 1$. The case $\cstl^{\circled{C_{i_t}}}_{j} = 0$ is simpler and can be discussed similarly. Suppose $y_j \in Y$.  In the following, we check that the constant atom and the coefficients of all the non-constant atoms of ${\sumf^{(\schm,\sumf^{(H,\initval_\bot)})}}^-(y_j)$ belong to $U$.  
%For brevity, we abbreviate an(resp. the) atom of ${\sumf^{(\schm,\sumf^{(H,\initval_\bot)})}}^-(y_j)$ as an (resp. the) atom below.
\begin{itemize}
	\item $(\cste^{\circled{\schm}}_{j})' = 0 + (\cstl^{\circled{C_{i_t}}}_{j})^{\ell_t} (\cste^{\circled{\schm_1}}_j)' = (\cste^{\circled{\schm_1}}_j)' \in U$ (here $\cste^{\circled{C_{i_t}}}_{j} \ell_t$ is removed).
	%
	\item For each $j' \in [r^{\circled{H}}]$ s.t. there exists no $j'' \in [k]$ satisfying that ${\sumf^{(\schm_1,\sumf^{(H,\initval_\bot)})}}^-(x_{j''})=\vard^{\circled{H}}_{j'}$, $(\csta^{\circled{\schm}}_{j, j'})' = (\cstl^{\circled{C_{i_t}}}_{j})^{\ell_t} (\csta^{\circled{\schm_1}}_{j, j'})' = (\csta^{\circled{\schm_1}}_{j, j'})' \in U$.
	%
	\item For each $j' \in [r^{\circled{H}}]$ such that ${\sumf^{(\schm_1,\sumf^{(H,\initval_\bot)})}}^-(x_{j''})=\vard^{\circled{H}}_{j'}$ for some $j''  \in I^{\circled{C_{i_t}}}_{pe}$, $(\csta^{\circled{\schm}}_{j, j'})' = 0 + (\cstl^{\circled{C_{i_t}}}_{j})^{\ell_t} (\csta^{\circled{\schm_1}}_{j, j'})'= (\csta^{\circled{\schm_1}}_{j, j'})' \in U$ (here $\csta^{\circled{C_{i_t}}}_{j,j'} \ell_t$ is removed). In this case, we have ${\sumf^{(\schm,\sumf^{(H,\initval_\bot)})}}^-(x_{j''})=\vard^{\circled{H}}_{j'}$. From the induction hypothesis, it is easy to see that the second result holds for $\schm$, $y_j$.
	%
	\item For each $j' \in [r^{\circled{H}}]$ such that ${\sumf^{(\schm_1,\sumf^{(H,\initval_\bot)})}}^-(x_{j''})=\vard^{\circled{H}}_{j'}$ for some $j''  \in I^{\circled{C_{i_t}}}_{tr}$, $(\csta^{\circled{\schm}}_{j, j'})' =(\cstl^{\circled{C_{i_t}}}_{j})^{\ell_t-1} \csta^{\circled{C_{i_t}}}_{j,j''} + (\cstl^{\circled{C_{i_t}}}_{j})^{\ell_t} (\csta^{\circled{\schm_1}}_{j, j'})' = \csta^{\circled{C_{i_t}}}_{j,j''} + (\csta^{\circled{\schm_1}}_{j, j'})' $. From the induction hypothesis, we know that either $(\csta^{\circled{\schm_1}}_{j, j'})' = \csta^{\circled{C_{i_{s_0}}}}_{j,j''}$ if there is $s$ such that $\cstl^{\circled{C_{i_s}}}_j =0$,  or otherwise, $(\csta^{\circled{\schm_1}}_{j, j'})'=\cstb^{\circled{H}}_{j, j'}$. Therefore, $(\csta^{\circled{\schm}}_{j, j'})' =\csta^{\circled{C_{i_t}}}_{j,j''} +  \csta^{\circled{C_{i_{s_0}}}}_{j,j''}$ or $\csta^{\circled{C_{i_t}}}_{j,j''}+ \cstb^{\circled{H}}_{j, j'}$. We conclude that $(\csta^{\circled{\schm}}_{j, j'})' \in U$.
	%
	\item For each $s \in [t-1]$, $i \in [\ell_s]$, and $j' \in [r^{\circled{C_{i_s}}}]$ such that there does not exist $j'' \in [k]$ satisfying that ${\sumf^{(\schm_1,\sumf^{(H,\initval_\bot)})}}^-(x_{j''}) = \vard^{\circled{C_{i_s}, i}}_{s, j'}$, it holds that $(\cstb^{\circled{\schm,i}}_{s,j'})' = (\cstl^{\circled{C_{i_t}}}_{j})^{\ell_t}  (\cstb^{\circled{\schm_1, i}}_{s, j'})'  =  (\cstb^{\circled{\schm_1, i}}_{s, j'})'  \in U$. 
	%
	\item For each $s \in [t-1]$, $i \in [\ell_s]$, and $j' \in [r^{\circled{C_{i_s}}}]$ such that ${\sumf^{(\schm_1,\sumf^{(H,\initval_\bot)})}}^-(x_{j''}) = \vard^{\circled{C_{i_s}, i}}_{s, j'}$ for some $j'' \in I^{\circled{C_{i_t}}}_{pe}$, $(\cstb^{\circled{\schm,i}}_{s,j'})' =(\cstl^{\circled{C_{i_t}}}_{j})^{\ell_t}  (\cstb^{\circled{\schm_1, i}}_{s, j'})'+ 0  =  (\cstb^{\circled{\schm_1, i}}_{s, j'})' \in U$ (here $\csta^{\circled{C_{i_t}}}_{j, j''} \ell_t$ is removed). Moreover, from the induction hypothesis, the third condition holds for $\schm$ and $y_j$.
	%
	\item For each $s \in [t-1]$, $i \in [\ell_s]$, and $j' \in [r^{\circled{C_{i_s}}}]$ such that ${\sumf^{(\schm_1,\sumf^{(H,\initval_\bot)})}}^-(x_{j''}) = \vard^{\circled{C_{i_s}, i}}_{s, j'}$ for some $j'' \in I^{\circled{C_{i_t}}}_{tr}$, it holds that $i = \ell_s$, $j'' \in I^{\circled{C_{i_s}}}_{tr}$, and for each $s': s < s' \le t$, $j'' \in I^{\circled{C_{i_{s'}}}}_{pe}$. Then $(\cstb^{\circled{\schm,i}}_{s,j'})' =(\cstl^{\circled{C_{i_t}}}_{j})^{\ell_t}  (\cstb^{\circled{\schm_1, i}}_{s, j'})' + \csta^{\circled{C_{i_t}}}_{j, j''}  =  (\cstb^{\circled{\schm_1, i}}_{s, j'})' + \csta^{\circled{C_{i_t}}}_{j, j''}$. From the induction hypothesis,  if there is $s': s < s' \le t-1$ such that $\cstl^{\circled{C_{i_{s'}}}}_j =0$, let $s'_0$ be the maximum $s'$ satisfying the constraint, then $(\cstb^{\circled{\schm_1, i}}_{j,j'})'=\csta^{\circled{C_{i_{s'_0}}}}_{j, j''}$, otherwise, $(\cstb^{\circled{\schm_1, i}}_{j,j'})'= \cstb^{\circled{C_{i_s}}}_{j,j'}$. Therefore, $(\cstb^{\circled{\schm,i}}_{s,j'})' = \csta^{\circled{C_{i_{s'_0}}}}_{j, j''} + \csta^{\circled{C_{i_t}}}_{j, j''}$ or $\cstb^{\circled{C_{i_s}}}_{j,j'} + \csta^{\circled{C_{i_t}}}_{j, j''}$, thus belongs to $U$. In this case, ${\sumf^{(\schm,\sumf^{(H,\initval_\bot)})}}^-(x_{j''})=\vard^{\circled{C_{i_t},\ell_t}}_{t, \pi^{\circled{C_{i_t}}}(j'')}$ and $(\cstb^{\circled{\schm,\ell_t}}_{t, \pi^{\circled{C_{i_t}}}(j'')})' = \cstb^{\circled{C_{i_t}}}_{j, \pi^{\circled{C_{i_t}}}(j'')}$. So the third condition holds for $\schm$ and $y_j$.
	%
	\item The coefficients of all the other atoms are those of  the $\vard^{\circled{C_{i_t}, i}}_{j, j'}$-atoms for $i \in [\ell_t]$ in ${\sumf^{(C^{\ell_t}_{i_t},\sumf^{(H,\initval_\bot)})}}^-(y_j)$.
\end{itemize} \qed

\end{proof}
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%the proof of the claim%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\end{appendix}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



